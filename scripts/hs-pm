#!/usr/bin/env python3
"""
hs-pm: Hammerspoon Package Manager for power-spoons
A CLI tool to manage Hammerspoon spoons installation and configuration
"""

import argparse
import json
import os
import shutil
import subprocess
import sys
from pathlib import Path
from typing import Dict, List, Optional

# ANSI color codes
class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def print_header(text: str):
    print(f"\n{Colors.HEADER}{Colors.BOLD}{text}{Colors.ENDC}")

def print_success(text: str):
    print(f"{Colors.OKGREEN}✓{Colors.ENDC} {text}")

def print_error(text: str):
    print(f"{Colors.FAIL}✗{Colors.ENDC} {text}")

def print_warning(text: str):
    print(f"{Colors.WARNING}⚠{Colors.ENDC} {text}")

def print_info(text: str):
    print(f"{Colors.OKCYAN}ℹ{Colors.ENDC} {text}")

class HammerspoonPackageManager:
    def __init__(self):
        self.repo_dir = Path(__file__).parent.parent.absolute()
        self.hs_dir = Path.home() / ".hammerspoon"
        self.manifest_path = self.repo_dir / "manifests" / "spoons.json"
        self.config_path = self.hs_dir / "modules_config.lua"

    def load_manifest(self) -> List[Dict]:
        """Load spoons manifest"""
        with open(self.manifest_path, 'r') as f:
            return json.load(f)

    def check_hammerspoon_installed(self) -> bool:
        """Check if Hammerspoon is installed"""
        return Path("/Applications/Hammerspoon.app").exists()

    def get_latest_hammerspoon_release(self) -> Optional[str]:
        """Get the latest Hammerspoon release URL from GitHub"""
        try:
            # Use curl to get latest release info (avoids SSL certificate issues)
            result = subprocess.run([
                "curl", "-s",
                "https://api.github.com/repos/Hammerspoon/hammerspoon/releases/latest"
            ], capture_output=True, text=True)

            if result.returncode != 0:
                print_error(f"Failed to fetch release info: {result.stderr}")
                return None

            data = json.loads(result.stdout)
            # Find the .zip asset
            for asset in data.get('assets', []):
                if asset['name'].endswith('.zip'):
                    return asset['browser_download_url']
            return None
        except Exception as e:
            print_error(f"Failed to fetch latest release info: {e}")
            return None

    def install_hammerspoon(self):
        """Install Hammerspoon from GitHub releases"""
        print_header("Installing Hammerspoon...")
        print_info("Note: Homebrew is only needed for some spoon dependencies (like sox)")
        print_info("Hammerspoon itself is installed directly from GitHub releases")

        # Get latest release URL
        download_url = self.get_latest_hammerspoon_release()
        if not download_url:
            print_error("Could not find latest Hammerspoon release")
            print_info("Please download manually from: https://github.com/Hammerspoon/hammerspoon/releases/latest")
            sys.exit(1)

        print_info(f"Downloading from {download_url}")

        # Create temp directory
        import tempfile
        with tempfile.TemporaryDirectory() as tmpdir:
            zip_path = Path(tmpdir) / "Hammerspoon.zip"

            # Download the zip file using curl
            try:
                print_info("Downloading Hammerspoon...")
                result = subprocess.run([
                    "curl", "-L", "-o", str(zip_path), download_url
                ], capture_output=True, text=True)
                if result.returncode != 0:
                    print_error(f"Failed to download: {result.stderr}")
                    sys.exit(1)
                print_success("Download complete")
            except Exception as e:
                print_error(f"Failed to download: {e}")
                sys.exit(1)

            # Unzip
            print_info("Extracting...")
            result = subprocess.run(["unzip", "-q", str(zip_path), "-d", tmpdir])
            if result.returncode != 0:
                print_error("Failed to extract archive")
                sys.exit(1)

            # Find the .app bundle
            app_path = Path(tmpdir) / "Hammerspoon.app"
            if not app_path.exists():
                print_error("Hammerspoon.app not found in archive")
                sys.exit(1)

            # Move to /Applications
            dest_path = Path("/Applications/Hammerspoon.app")
            if dest_path.exists():
                print_warning("Removing existing Hammerspoon.app")
                shutil.rmtree(dest_path)

            print_info("Installing to /Applications...")
            shutil.copytree(app_path, dest_path)
            print_success("Hammerspoon installed successfully to /Applications/Hammerspoon.app")
            print_info("You can launch Hammerspoon from your Applications folder")

    def check_dependency(self, dep_type: str, dep: str) -> bool:
        """Check if a dependency is installed"""
        if dep_type == "brew":
            return subprocess.run(["brew", "list", dep],
                                capture_output=True).returncode == 0
        elif dep_type == "binaries":
            return subprocess.run(["which", dep],
                                capture_output=True).returncode == 0
        elif dep_type == "env":
            env_file = self.hs_dir / ".env"
            if env_file.exists():
                with open(env_file, 'r') as f:
                    for line in f:
                        if line.strip().startswith(dep):
                            # Check if it has a real value (not placeholder)
                            value = line.split('=', 1)[1].strip() if '=' in line else ''
                            if value and not value.endswith('_here'):
                                return True
            return False
        return False

    def install_dependency(self, dep_type: str, dep: str):
        """Install a dependency"""
        if dep_type == "brew":
            print_info(f"Installing {dep} via Homebrew...")
            result = subprocess.run(["brew", "install", dep])
            if result.returncode == 0:
                print_success(f"{dep} installed successfully")
            else:
                print_error(f"Failed to install {dep}")
        elif dep_type == "env":
            self.prompt_for_env_var(dep)

    def prompt_for_env_var(self, var_name: str):
        """Prompt user for environment variable"""
        env_file = self.hs_dir / ".env"

        print_info(f"Environment variable {var_name} is required")
        value = input(f"Enter {var_name} (or press Enter to skip): ").strip()

        if value:
            # Append to .env file
            with open(env_file, 'a') as f:
                f.write(f"\n{var_name}={value}\n")
            print_success(f"{var_name} added to .env")
        else:
            print_warning(f"{var_name} not set - spoon may not work properly")

    def read_config(self) -> Dict:
        """Read current modules configuration"""
        if not self.config_path.exists():
            return {"modules": {}}

        # Parse Lua config (simple approach)
        config = {"modules": {}}
        with open(self.config_path, 'r') as f:
            content = f.read()
            # Extract enabled status for each module
            for spoon in self.load_manifest():
                spoon_id = spoon["id"]
                if f'{spoon_id} = {{' in content:
                    if 'enabled = true' in content.split(spoon_id)[1].split('},')[0]:
                        config["modules"][spoon_id] = {"enabled": True}
                    else:
                        config["modules"][spoon_id] = {"enabled": False}

        return config

    def write_config(self, enabled_modules: List[str]):
        """Write modules configuration"""
        template_path = self.repo_dir / "templates" / "modules_config.lua"

        with open(template_path, 'r') as f:
            content = f.read()

        # Replace placeholders
        content = content.replace("{{WHISPER_ENABLED}}", "true" if "whisper" in enabled_modules else "false")
        content = content.replace("{{LYRICS_ENABLED}}", "true" if "lyrics" in enabled_modules else "false")
        content = content.replace("{{GEMINI_ENABLED}}", "true" if "gemini" in enabled_modules else "false")
        content = content.replace("{{TRIMMY_ENABLED}}", "true" if "trimmy" in enabled_modules else "false")

        with open(self.config_path, 'w') as f:
            f.write(content)

        print_success(f"Configuration written to {self.config_path}")

    def install_core_files(self):
        """Copy core files to ~/.hammerspoon"""
        print_header("Installing core files...")

        # Create .hammerspoon directory if it doesn't exist
        self.hs_dir.mkdir(parents=True, exist_ok=True)

        # Copy lib directory
        lib_src = self.repo_dir / "core" / "lib"
        lib_dst = self.hs_dir / "lib"
        if lib_dst.exists():
            shutil.rmtree(lib_dst)
        shutil.copytree(lib_src, lib_dst)
        print_success("Copied lib directory")

        # Copy spoons directory
        spoons_src = self.repo_dir / "core" / "spoons"
        spoons_dst = self.hs_dir / "spoons"
        if spoons_dst.exists():
            shutil.rmtree(spoons_dst)
        shutil.copytree(spoons_src, spoons_dst)
        print_success("Copied spoons directory")

        # Copy init.lua
        init_src = self.repo_dir / "templates" / "init.lua"
        init_dst = self.hs_dir / "init.lua"
        shutil.copy(init_src, init_dst)
        print_success("Copied init.lua")

        # Copy .env.example if .env doesn't exist
        env_dst = self.hs_dir / ".env"
        if not env_dst.exists():
            env_example_src = self.repo_dir / "templates" / ".env.example"
            shutil.copy(env_example_src, env_dst)
            print_success("Created .env file")

    def select_spoons(self) -> List[str]:
        """Interactive spoon selection"""
        manifest = self.load_manifest()
        selected = []

        print_header("Available Spoons")
        print("Select which spoons to install:\n")

        for spoon in manifest:
            default = "Y" if spoon["defaultEnabled"] else "n"
            prompt = f"{spoon['name']} - {spoon['description']}"
            if spoon.get('hotkey'):
                prompt += f" [{spoon['hotkey']}]"

            response = input(f"{prompt}\n  Enable? [Y/n] (default: {default}): ").strip().lower()

            if response == '' and default == 'Y':
                response = 'y'
            elif response == '' and default == 'n':
                response = 'n'

            if response == 'y':
                selected.append(spoon["id"])
                print_success(f"  {spoon['name']} will be enabled\n")
            else:
                print_info(f"  {spoon['name']} will be disabled\n")

        return selected

    def install_spoon_dependencies(self, spoon_id: str):
        """Install dependencies for a specific spoon"""
        manifest = self.load_manifest()
        spoon = next((s for s in manifest if s["id"] == spoon_id), None)

        if not spoon:
            print_error(f"Spoon '{spoon_id}' not found")
            return

        deps = spoon.get("dependencies", {})

        for dep_type, dep_list in deps.items():
            for dep in dep_list:
                if not self.check_dependency(dep_type, dep):
                    print_warning(f"Dependency {dep} not found")
                    self.install_dependency(dep_type, dep)
                else:
                    print_success(f"Dependency {dep} already installed")

    def cmd_init(self):
        """Initialize Hammerspoon configuration"""
        print_header("Power Spoons Installer")

        # Check Hammerspoon
        if not self.check_hammerspoon_installed():
            print_warning("Hammerspoon not installed")
            response = input("Install Hammerspoon now? [Y/n]: ").strip().lower()
            if response in ['', 'y', 'yes']:
                self.install_hammerspoon()
            else:
                print_error("Hammerspoon is required. Exiting.")
                sys.exit(1)
        else:
            print_success("Hammerspoon is installed")

        # Backup existing config
        if self.hs_dir.exists():
            backup_dir = Path.home() / f".hammerspoon.backup-{int(os.times().elapsed * 1000)}"
            print_warning(f"Backing up existing config to {backup_dir}")
            shutil.copytree(self.hs_dir, backup_dir)

        # Install core files
        self.install_core_files()

        # Select spoons
        selected_spoons = self.select_spoons()

        # Install dependencies
        print_header("Installing dependencies...")
        for spoon_id in selected_spoons:
            print_info(f"Checking dependencies for {spoon_id}...")
            self.install_spoon_dependencies(spoon_id)

        # Write config
        self.write_config(selected_spoons)

        print_header("Installation Complete!")
        print_info("Reload Hammerspoon to activate your spoons")
        print_info("You can manage spoons with: hs-pm add/remove <spoon>")

    def cmd_list(self):
        """List installed spoons"""
        config = self.read_config()
        manifest = self.load_manifest()

        print_header("Installed Spoons")
        for spoon in manifest:
            enabled = config.get("modules", {}).get(spoon["id"], {}).get("enabled", False)
            status = f"{Colors.OKGREEN}[+] enabled{Colors.ENDC}" if enabled else f"{Colors.WARNING}[!] disabled{Colors.ENDC}"
            print(f"\n{Colors.BOLD}{spoon['name']}{Colors.ENDC} ({spoon['id']}) - {status}")
            print(f"  {spoon['description']}")
            if spoon.get('hotkey'):
                print(f"  Hotkey: {spoon['hotkey']}")

    def cmd_available(self):
        """List available spoons"""
        manifest = self.load_manifest()

        print_header("Available Spoons")
        for spoon in manifest:
            print(f"\n{Colors.BOLD}{spoon['name']}{Colors.ENDC} ({spoon['id']})")
            print(f"  {spoon['description']}")
            if spoon.get('hotkey'):
                print(f"  Hotkey: {spoon['hotkey']}")

            deps = spoon.get("dependencies", {})
            if deps:
                print(f"  Dependencies:")
                for dep_type, dep_list in deps.items():
                    for dep in dep_list:
                        print(f"    - {dep} ({dep_type})")

    def cmd_add(self, spoon_id: str):
        """Add/enable a spoon"""
        manifest = self.load_manifest()
        spoon = next((s for s in manifest if s["id"] == spoon_id), None)

        if not spoon:
            print_error(f"Spoon '{spoon_id}' not found")
            return

        config = self.read_config()
        current_modules = [k for k, v in config.get("modules", {}).items() if v.get("enabled")]

        if spoon_id in current_modules:
            print_warning(f"{spoon['name']} is already enabled")
            return

        print_header(f"Adding {spoon['name']}...")

        # Install dependencies
        self.install_spoon_dependencies(spoon_id)

        # Update config
        current_modules.append(spoon_id)
        self.write_config(current_modules)

        print_success(f"{spoon['name']} has been enabled")
        print_info("Reload Hammerspoon to activate")

    def cmd_remove(self, spoon_id: str):
        """Remove/disable a spoon"""
        manifest = self.load_manifest()
        spoon = next((s for s in manifest if s["id"] == spoon_id), None)

        if not spoon:
            print_error(f"Spoon '{spoon_id}' not found")
            return

        config = self.read_config()
        current_modules = [k for k, v in config.get("modules", {}).items() if v.get("enabled")]

        if spoon_id not in current_modules:
            print_warning(f"{spoon['name']} is already disabled")
            return

        current_modules.remove(spoon_id)
        self.write_config(current_modules)

        print_success(f"{spoon['name']} has been disabled")
        print_info("Reload Hammerspoon to apply changes")

    def cmd_update(self):
        """Update power-spoons repository and sync files"""
        print_header("Updating power-spoons...")

        # Git pull
        result = subprocess.run(["git", "pull"], cwd=self.repo_dir)
        if result.returncode != 0:
            print_error("Failed to update repository")
            return

        # Re-install core files (preserving config)
        config_backup = None
        if self.config_path.exists():
            with open(self.config_path, 'r') as f:
                config_backup = f.read()

        self.install_core_files()

        if config_backup:
            with open(self.config_path, 'w') as f:
                f.write(config_backup)

        print_success("Update complete")
        print_info("Reload Hammerspoon to apply updates")

def main():
    parser = argparse.ArgumentParser(
        description="hs-pm: Hammerspoon Package Manager for power-spoons",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  hs-pm init              Initialize Hammerspoon with power-spoons
  hs-pm list              List installed spoons
  hs-pm available         List all available spoons
  hs-pm add whisper       Add and enable whisper spoon
  hs-pm remove lyrics     Remove/disable lyrics spoon
  hs-pm update            Update power-spoons to latest version
        """
    )

    subparsers = parser.add_subparsers(dest='command', help='Command to run')

    # Init command
    subparsers.add_parser('init', help='Initialize Hammerspoon configuration')

    # List command
    subparsers.add_parser('list', help='List installed spoons')

    # Available command
    subparsers.add_parser('available', help='List all available spoons')

    # Add command
    add_parser = subparsers.add_parser('add', help='Add/enable a spoon')
    add_parser.add_argument('spoon', help='Spoon ID to add')

    # Remove command
    remove_parser = subparsers.add_parser('remove', help='Remove/disable a spoon')
    remove_parser.add_argument('spoon', help='Spoon ID to remove')

    # Update command
    subparsers.add_parser('update', help='Update power-spoons repository')

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    pm = HammerspoonPackageManager()

    if args.command == 'init':
        pm.cmd_init()
    elif args.command == 'list':
        pm.cmd_list()
    elif args.command == 'available':
        pm.cmd_available()
    elif args.command == 'add':
        pm.cmd_add(args.spoon)
    elif args.command == 'remove':
        pm.cmd_remove(args.spoon)
    elif args.command == 'update':
        pm.cmd_update()

if __name__ == '__main__':
    main()
